"use strict";(self.webpackChunkfused_docs=self.webpackChunkfused_docs||[]).push([[6624],{6714:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>d,toc:()=>h});var n=s(4848),a=s(8453),i=s(3650);const o='import pydeck as pdk\nimport streamlit as st\n\nst.header(\'Zonal Stats\')\n\nst.write("""\nIn this tutorial we\'ll focus on zonal statistics between a raster and polygons in a table. We\'ll explore how to perform zonal statistics to approximate the height of buildings using a digital surface model (DSM) raster dataset and a table of building footprint polygons. The raster is the ALOS Global DSM "ALOS World 3D - 30m (AW3D30)" captured by the PRISM optical sensor on the ALOS satellite, with a 30-meter horizontal resolution. The buildings dataset is the "Building Footprints" dataset from Microsoft, which contains the `Polygon` of buildings in the United States.\n\n\nThis example interactively illustrates zonal statistics between a raster and a table of polygons: the raster array is represented by a grayscale image of the DSM and the building footprint are represented with purple `Polygon` objects. \n\n\nUsers can interact with the checkboxes on the sidebar to toggle show/hide:\n- The raster image\n- The building footprint outlines\n- The building footprints colored by the mean pixel value of the raster\n\nYou\'ll notice that the building footprints are colored based on the mean pixel value of the raster within the polygon. The color scale ranges from dark (low values) to bright (high values). This visualization helps identify buildings with higher or lower height based on the average pixel values. \n\n""")\n\n# Create map\nlat, lng = 40.76965, -73.990094\n\nlayers = {\n    "raster": pdk.Layer(\n        "BitmapLayer",\n        # data="https://staging.fused.io/server/v1/realtime-shared/bb187c65d00ffd0d0dfca0e01008699cc80d99ab8a4b9411f451540df379368f/run/tiles/{z}/{x}/{y}?dtype_out_raster=png&dtype_out_vector=geojson",\n        image="https://staging.fused.io/server/v1/realtime-shared/bb187c65d00ffd0d0dfca0e01008699cc80d99ab8a4b9411f451540df379368f/run/tiles/14/4824/6156?dtype_out_raster=png&return_object=arr",\n        bounds=[-74.00390625, 40.76390128094588, -73.98193359375, 40.780541431860314],\n        opacity=2,\n        # tooltip={"text": "Agg value: {cnt}"} # TODO: UDF should return properties\n    ),\n    "vector": pdk.Layer(\n        "GeoJsonLayer",\n        data="https://staging.fused.io/server/v1/realtime-shared/bb187c65d00ffd0d0dfca0e01008699cc80d99ab8a4b9411f451540df379368f/run/tiles/16/19298/24626?dtype_out_raster=png&dtype_out_vector=geojson",\n        pickable=True,\n        filled=False,\n        stroked=True,\n        get_line_color="[100, 0, 252]",\n        get_line_width=4,\n    ),\n    # TODO\n    # \'raster2\': pdk.Layer(\n    #     "RasterTileLayer",\n    #     data="https://staging.fused.io/server/v1/realtime-shared/bb187c65d00ffd0d0dfca0e01008699cc80d99ab8a4b9411f451540df379368f/run/tiles/{z}/{x}/{y}?dtype_out_raster=png",\n    #     opacity=200,\n    # ),\n    "vector_sz": pdk.Layer(\n        "GeoJsonLayer",\n        # data="https://staging.fused.io/server/v1/realtime-shared/bb187c65d00ffd0d0dfca0e01008699cc80d99ab8a4b9411f451540df379368f/run/tiles/{z}/{x}/{y}?dtype_out_raster=png&dtype_out_vector=geojson",\n        data="https://staging.fused.io/server/v1/realtime-shared/bb187c65d00ffd0d0dfca0e01008699cc80d99ab8a4b9411f451540df379368f/run/tiles/16/19298/24626?dtype_out_raster=png&dtype_out_vector=geojson",\n        pickable=True,\n        filled=True,\n        stroked=False,\n        get_fill_color="[properties.count*.3, properties.count*0.10, properties.count*2]",\n        get_line_width=0,\n        tooltip={\n            "text": "Agg value: {properties.count}"\n        },  # TODO: UDF should return properties\n    ),\n}\n\n# Filter based on checkboxes\nshow_raster = st.sidebar.checkbox("Show raster", value=True)\nif not show_raster:\n    layers.pop("raster")\nshow_vector = st.sidebar.checkbox("Show vector", value=True)\nif not show_vector:\n    layers.pop("vector")\nshow_vector_zs = st.sidebar.checkbox("Show vector with zonal stats", value=True)\nif not show_vector_zs:\n    layers.pop("vector_sz")\n\nst.pydeck_chart(\n    pdk.Deck(\n        map_style="mapbox://styles/mapbox/dark-v9",\n        initial_view_state=pdk.ViewState(\n            latitude=lat,\n            longitude=lng,\n            zoom=15,\n            pitch=0,\n        ),\n        layers=list(layers.values()),\n    )\n)',r={id:"zonal-stats",title:"Zonal Stats",tags:["zonal","stats"]},l="Zonal Statistics: A Comprehensive Guide",d={id:"basics/usecases/zonal-stats",title:"Zonal Stats",description:"Zonal statistics is a versatile tool to summarize raster data within defined zones, providing valuable insights across multiple domains. It's a geospatial technique that calculates aggregate statistics (e.g., mean, sum, maximum) of the pixel values of a raster (i.e. cell values) that fall within areas defined by another dataset. The method has diverse applications such as determining vegetation health in an agricultural field, assess surface water availability in watersheds, or approximate the height of buildings.",source:"@site/docs/basics/usecases/zonal_stats.mdx",sourceDirName:"basics/usecases",slug:"/basics/usecases/zonal-stats",permalink:"/basics/usecases/zonal-stats",draft:!1,unlisted:!1,tags:[{label:"zonal",permalink:"/tags/zonal"},{label:"stats",permalink:"/tags/stats"}],version:"current",frontMatter:{id:"zonal-stats",title:"Zonal Stats",tags:["zonal","stats"]},sidebar:"tutorialSidebar",previous:{title:"Raster to H3",permalink:"/basics/usecases/raster-h3"},next:{title:"Utilities",permalink:"/basics/utilities"}},c={},h=[{value:"Applications",id:"applications",level:2},{value:"Urban Analysis",id:"urban-analysis",level:3},{value:"Environmental Management",id:"environmental-management",level:3},{value:"Implementing zonal statistics",id:"implementing-zonal-statistics",level:2},{value:"Implementation steps",id:"implementation-steps",level:3},{value:"Example UDF",id:"example-udf",level:3},{value:"Scaling up with Fused",id:"scaling-up-with-fused",level:3},{value:"Conclusion",id:"conclusion",level:2},{value:"\u2b50 Demo app",id:"-demo-app",level:2}];function u(e){const t={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"zonal-statistics-a-comprehensive-guide",children:"Zonal Statistics: A Comprehensive Guide"}),"\n",(0,n.jsx)(t.p,{children:"Zonal statistics is a versatile tool to summarize raster data within defined zones, providing valuable insights across multiple domains. It's a geospatial technique that calculates aggregate statistics (e.g., mean, sum, maximum) of the pixel values of a raster (i.e. cell values) that fall within areas defined by another dataset. The method has diverse applications such as determining vegetation health in an agricultural field, assess surface water availability in watersheds, or approximate the height of buildings."}),"\n",(0,n.jsx)("iframe",{src:"/img/deckgl_vector_zstats.html",height:"400px",width:"100%",scrolling:"no"}),"\n",(0,n.jsx)(t.h2,{id:"applications",children:"Applications"}),"\n",(0,n.jsx)(t.h3,{id:"urban-analysis",children:"Urban Analysis"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Approximate the height of buildings using DSM."}),"\n",(0,n.jsx)(t.li,{children:"Determine buildings with greenery on rooftops using NDVI rasters."}),"\n",(0,n.jsx)(t.li,{children:"Identify buildings with solar panels using solar radiation rasters."}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"environmental-management",children:"Environmental Management"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Precision Agriculture: Determine vegetation health within crop polygons using NDVI rasters."}),"\n",(0,n.jsx)(t.li,{children:"Water Resource Management: Assess surface water availability in watersheds using NDWI rasters."}),"\n",(0,n.jsx)(t.li,{children:"Environmental Monitoring: Track forest cover percentage within administrative zones and monitor changes over time using LULC rasters."}),"\n",(0,n.jsx)(t.li,{children:"Assess building density in urban areas using LULC rasters."}),"\n"]}),"\n",(0,n.jsx)("div",{style:{textAlign:"center"},children:(0,n.jsx)("img",{src:"https://camo.githubusercontent.com/c2f7fcebe282d2834a24b95de0d2dca7cfbced457e7193f921afe2672ae9f771/68747470733a2f2f66757365642d6d616769632e73332e75732d776573742d322e616d617a6f6e6177732e636f6d2f7468756d626e61696c732f756466732d73746167696e672f44534d5f5a6f6e616c5f53746174732e706e67",alt:"File",style:{width:600}})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsxs)(t.em,{children:["Visual representation of building ",(0,n.jsx)(t.code,{children:"Polygon"})," objects colored based on DSM aggregate values."]})}),"\n",(0,n.jsx)(t.h2,{id:"implementing-zonal-statistics",children:"Implementing zonal statistics"}),"\n",(0,n.jsx)(t.p,{children:"Determining the pixels that within a polygon requires using analysis packages that can operate on both raster and vector data. Once the pixels are identified, we can calculate aggregate statistics such as the mean, sum, or maximum of the pixel values within the polygon."}),"\n",(0,n.jsx)(t.h3,{id:"implementation-steps",children:"Implementation steps"}),"\n",(0,n.jsxs)(t.p,{children:["To perform this operation, we can load raster and vector data for spatially overlapping area then perform zonal statistics using methods in ",(0,n.jsx)(t.code,{children:"xarray"})," and ",(0,n.jsx)(t.code,{children:"GeoPandas"})," libraries. Here's how to do this:"]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Load overlapping the raster and vector data"}),"\n",(0,n.jsxs)(t.li,{children:["For the extent of each ",(0,n.jsx)(t.code,{children:"Polygon"}),", clip the raster to create a mask array"]}),"\n",(0,n.jsx)(t.li,{children:"Perform an aggregation operation (e.g., mean, sum, max) on each masked array"}),"\n",(0,n.jsxs)(t.li,{children:["Return the results in a ",(0,n.jsx)(t.code,{children:"GeoDataFrame"}),", where each row corresponds to a ",(0,n.jsx)(t.code,{children:"Polygon"})," and the a columns contain the value for the aggregate zonal statistics"]}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"example-udf",children:"Example UDF"}),"\n",(0,n.jsxs)(t.p,{children:["This example UDF loads the building footprint table ",(0,n.jsx)(t.code,{children:"gdf"})," and DSM raster ",(0,n.jsx)(t.code,{children:"arr"})," from S3 only for a section defined by ",(0,n.jsx)(t.code,{children:"bbox"}),", which corresponds to a map tile. It then calculates the zonal statistics, and returns the results as the ",(0,n.jsx)(t.code,{children:"GeoDataFrame"})," ",(0,n.jsx)(t.code,{children:"gdf_zonal"}),". This process enables Fused workbench to perform the calculation dynamically as users scroll and zoom in the map."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:'@fused.udf\ndef udf(\n    bbox, min_zoom=15, table="s3://fused-asset/infra/building_msft_us/", chip_len=256\n):\n    import utils\n\n    gdf = utils.table_to_tile(bbox, table, min_zoom)\n    arr = utils.dsm_to_tile(bbox, z_levels=[4, 6, 9, 11], verbose=False)\n    gdf_zonal = utils.geom_stats(gdf, arr, chip_len=chip_len)\n    return gdf_zonal\n'})}),"\n",(0,n.jsxs)(t.p,{children:["The UDF would return a ",(0,n.jsx)(t.code,{children:"GeoDataFrame"})," like the following, with an aggregate ",(0,n.jsx)(t.code,{children:"stats"})," column for each input ",(0,n.jsx)(t.code,{children:"Polygon"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-plaintext",children:"                                                geometry      stats  count\n660    POLYGON ((-122.39806 37.76221, -122.39806 37.7...  22.000000      5\n661    POLYGON ((-122.39881 37.76219, -122.39876 37.7...  21.994819    193\n1452   POLYGON ((-122.39619 37.76326, -122.39613 37.7...  13.500000      2\n1458   POLYGON ((-122.39774 37.76327, -122.39776 37.7...  11.000000     28\n3033   POLYGON ((-122.39680 37.76362, -122.39701 37.7...  10.200000      5\n...\n"})}),"\n",(0,n.jsx)(t.h3,{id:"scaling-up-with-fused",children:"Scaling up with Fused"}),"\n",(0,n.jsx)(t.p,{children:"Zonal stats can be challenging to implement on large datasets because some tools are specialized to work with either, but not both. As such, handling large datasets, such as nationwide building footprints and high-resolution rasters, requires strategic approaches to process data."}),"\n",(0,n.jsx)(t.p,{children:"To perform zonal stats on large datasets, Fused UDFs can be used to spatially filter the raster and table to only perform calculations over subsections of the data that spatially overlap. This enables the computation to be performed in parallel across multiple workers, making it scalable to any size dataset."}),"\n",(0,n.jsx)(t.p,{children:"// TODO: mention running w/ multiprocess"}),"\n",(0,n.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,n.jsx)(t.p,{children:"While zonal statistics is a valuable tool, it's often just the starting point for more complex analyses. Combining zonal statistics with other techniques such time series analysis or machine learning approaches can provide even richer insights into your data."}),"\n",(0,n.jsx)(t.h2,{id:"-demo-app",children:"\u2b50 Demo app"}),"\n","\n","\n",(0,n.jsx)(i.A,{id:"zonal-stats",url:"https://staging.fused.io/workbench#app/s/aH4sIAAAAAAAAA91Ye2%2FbNhD%2FKoQCLPZgW5JfsQwIQ7sgRYcWLZp0xVYVLi1RMhuK1EjKsRP4u%2B8oSn7lsWx%2FbMXiBJaO5D1%2Fd7zLnROLhDhTh%2BaFkBoV64TE1wgrVCTXEa%2BpSkuCc0a1WVA64hFXurcgOCGydfq74JihS421Om3XazeSatKKnOrDX3OkF1QhXWohKWy%2BIaeMoVTEpUKCo9uKgwIOVGkaKzQn%2BoYQjjCSWGkiEeYJKgRbZ4IrRM2CxnNGeuhTxYmsCiYkQQtxg7RABZGpkPl9vrCGi0KKFc2xJqAUHCE0W2gkUjQvKUsozxQqFXyBjIRmVBsOpUxxTFAOvmKodX75tt0olmCNFdGVgrVS%2B7zARqELSbneqt9DVyC2Pm6cAm8v3ry7RK%2BYmIMw4I4ip6J8EpIlaHCOumjg5aj14tPgfOC1IwfFuNClJAmarysG7z%2B8hmOiACuNvoQrIY1nt8wV2MsggqSDbqhegK4Dr5sTo8MCYgKeMoZKogQrNRXcarlzSWNnrXDkvGwsvGgsVKBXsy2VIkdvaSyFEqkGmQsaL1BspFBuWXx9bx3y9dD31Cr9kYOuSYUqonoGVRG%2FMhgiK5wX4GQQSCSONV0StkaUsRJQajY%2FE017wWoiM60kN3ukxGtjriQFuIVwbb2NUQYLCtwMOuQ4qziYcyZuhrHe89te%2BDHAc59VFYWilMaWPVfMv5FYA0asxR8VkQqCzbfm2nNGRryATJ2LFVFNoBVNyBxLg3ItsgwYK0gIdwHkacS7B7gzmje0B7QVpWaUE%2FX4FlBLmJzbQjAnoGZBV5AhS8zKrV%2BsRGPNb6I0ycoFRMUkH9aPOEtV3tryB0QljY1PS6m8UyOojqoFcsUL2ahJzDNwWgXRBMtr1GJQNipuqm2cN5dVSWgt4KuhGzYAhiVVJWb0FpscgdrBCkBsAhGl6XoPxFWQzHFQCeQCf5NnttIcmIOXEFXA0J5FTfCr2lnV0xP0M9RfqFc5LiLOMOQTA3eFaOj1zsbBeNRB3bNBLwg8LxiaAwyvDW5CdBdxBD%2BRUwfBmZq63ntj1lt2za6%2FpBqYV%2FTI6exWTqqMDiNnoXWhpq4LaZWBib20BCt6VLiAULDBXfou6Mg0zUlXLSB8iTuf%2B5OzeDxKPC9NEw8%2BaYw94vmeNxkHQRxPvCQI8HyCh%2FNg6PvpcOSPhrBrcBYMxpPUlSV3NWVEuXe3G%2FduBX%2FrzU%2BJXhdkBgCdWaPCgmc%2F7IhLyB8hw4yIb0rwA2Mq0P%2FntvhDdzjpD92xPxo%2FbIwkUNv5zNaCEArRgRVzUfJEhZ%2B7Z8Oe5w0Cb9wHAFRQgBe%2FPwEQjCaTGhMTPxgMRsHgrN4z8UZDfzjwJ2Nv4A%2B%2F7PEVBY6pXof9g%2FBrIcARRXgXOZqstEEQXE5ZZrE6RXcx15vI2cDWq3fn76bo4%2FmFKTslXFzWDgT3LVzImppqYpi2Ow0qbaweR%2BUrIn6BIN6H5XcBSn%2Fs%2BkE%2FmLj94bj%2FSCifhcuCxtfmLgqvZEn26CncaiQJLzBT%2B2S458Q10I92Z0TPTM2eVbUOvPMZbOog%2BO2P%2Bl8OBG633tBEL8Jh5zAwNpTN86k1p396P0ondZw%2BVDuuwCuHoTr5foL1VxXkSOdtMoALG%2Foxbmfq9h9A939VUb8LU%2F6tPDyiNml4nJ4mucyJXR7uCmAvhuKtf%2BwNOuge0ev53gPkp1PX21valeotyWLx4cJ9LGljJrXm0KaD%2FmZF39hO5YIy04dtm5xdlwpzIXSjdVCgN4EpsW5Ye80mGBgvzQjXdCsdq2zleeiEaGp6R7THZmrl236nV4iitWt12rVAG%2FCnBTYX0RMC7ZaHBDaHDwXObtVzZNpWcTeyqGcoAawf16OqSs0Ybsf5WQw5p%2BvyZMrVORD3qhV0fjOl18z0RvAMOla5vDbJZd9d0yd3l8FhOwUjGgzzsyUlNzOjOwkN81%2FhtRrbWoc4hL6V6jIhoWlgj5YEz%2Bo1nh2t3QqRh%2F7oiFpQHR%2Biv733bN0SMpj%2FWrWLbGvdajfbwENtp%2BNI8kdJJcmhg1fO9LMDZaGAIQ6reo0obR5X1TQID2ssGXxZv8JD1VJSAU851gUTMDXN4WX7D5MujonzBfapi5Kxy1jCHOpMU1MyNn8Ck4LFonwRAAA%3D",code:o,requirements:["/pyarrow/pyarrow-17.0.0-cp312-cp312-pyodide_2024_0_wasm32.whl","pyodide-unix-timezones","geopandas","requests","xarray","yarl","pydeck"]})]})}function p(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(u,{...e})}):u(e)}},3650:(e,t,s)=>{s.d(t,{A:()=>i});var n=s(6540),a=s(4848);function i(e){let{id:t,url:s,code:i,requirements:o}=e;const r=(0,n.useRef)(null);function l(e,t){t.style.left=`${e.left+window.scrollX}px`,t.style.top=`${e.top+window.scrollY}px`,t.style.width=`${e.width}px`,t.style.height=`${e.height}px`}return(0,n.useEffect)((()=>{let e=null;document.getElementById("magic-iframe")?e=document.getElementById("magic-iframe"):(e=document.createElement("iframe"),e.src=s,e.height="1050px",e.width="100%",e.scrolling="no",e.id="magic-iframe",document.body.appendChild(e)),e.contentWindow.postMessage({appRunner:{code:i,enabled:!0,requirements:o}},s);const t=r.current.getBoundingClientRect();e.style.position="absolute",e.style.display="block",l(t,e);const n=new IntersectionObserver((e=>{for(const t of e)if(t.isIntersecting){const e=document.getElementById("magic-iframe");if(e){l(t.boundingClientRect,e)}}}));n.observe(r.current);const a=new ResizeObserver((e=>{for(const t of e)if(t.contentBoxSize){const e=document.getElementById("magic-iframe");if(e){l(r.current.getBoundingClientRect(),e)}}}));return a.observe(r.current),()=>{const e=document.getElementById("magic-iframe");e&&(e.style.left="-10000px",e.style.top="-10000px",e.style.width="0px",e.style.height="0px",e.style.display="none"),a.disconnect(),n.disconnect()}}),[]),(0,a.jsx)("div",{ref:r,style:{width:"100%",height:"1050px"}})}},8453:(e,t,s)=>{s.d(t,{R:()=>o,x:()=>r});var n=s(6540);const a={},i=n.createContext(a);function o(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);